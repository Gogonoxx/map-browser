<div class="map-browser-container">
  {{#if loading}}
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <span>{{localize "MAP_BROWSER.Loading"}}</span>
    </div>
  {{else}}
    <!-- Header -->
    <div class="browser-header">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" name="search" placeholder="{{localize 'MAP_BROWSER.Search'}}"
               value="{{searchQuery}}" autofocus>
      </div>
      <div class="stats">
        <span class="stat">
          <i class="fas fa-map-marker-alt"></i>
          {{totalLocations}} {{localize "MAP_BROWSER.Locations"}}
        </span>
        <span class="stat">
          <i class="fas fa-layer-group"></i>
          {{totalFlavors}} {{localize "MAP_BROWSER.Flavors"}}
        </span>
        <span class="stat">
          <i class="fas fa-file-image"></i>
          {{totalFiles}} {{localize "MAP_BROWSER.Files"}}
        </span>
      </div>
    </div>

    {{#unless hasOneDriveUrl}}
      <div class="warning-banner">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{localize "MAP_BROWSER.ConfigureOneDrive"}}</span>
      </div>
    {{/unless}}

    {{#if searchQuery}}
      <div class="search-results-info">
        <span>{{resultCount}} Ergebnisse für "{{searchQuery}}"</span>
        {{#unless resultCount}}
          <button class="clear-search" onclick="this.closest('.map-browser-container').querySelector('[name=search]').value=''; this.closest('.map-browser-container').querySelector('[name=search]').dispatchEvent(new Event('input'))">
            <i class="fas fa-times"></i> Suche löschen
          </button>
        {{/unless}}
      </div>
    {{/if}}

    <!-- Location Grid -->
    <div class="locations-grid">
      {{#each locations}}
        <div class="location-card {{#if expanded}}expanded{{/if}}" data-location-id="{{id}}">
          <!-- Card Header -->
          <div class="card-header" data-action="toggle-location" data-location-id="{{id}}">
            <img class="location-thumbnail" src="{{thumbnail}}" alt="{{title}}"
                 loading="lazy" onerror="this.src='icons/svg/mystery-man.svg'">
            <div class="card-info">
              <h3 class="location-title">{{title}}</h3>
              <div class="location-meta">
                <span class="flavor-count">{{flavor_count}} Varianten</span>
                {{#if has_animated}}
                  <span class="animated-badge" title="{{localize 'MAP_BROWSER.Animated'}}">
                    <i class="fas fa-film"></i>
                  </span>
                {{/if}}
              </div>
              <div class="smart-tags">
                {{#each tagBadges}}
                  <span class="tag tag-{{this}}">{{this}}</span>
                {{/each}}
              </div>
            </div>
            <i class="fas fa-chevron-{{#if expanded}}up{{else}}down{{/if}} expand-icon"></i>
          </div>

          <!-- Expanded Flavor Panel -->
          {{#if expanded}}
            <div class="flavors-panel">
              {{#each flavors}}
                <div class="flavor-group">
                  <div class="flavor-header">
                    <span class="flavor-name">{{display_name}}</span>
                    {{#if has_animated}}
                      <span class="animated-badge small">
                        <i class="fas fa-film"></i>
                      </span>
                    {{/if}}
                    {{#each smart_tags}}
                      <span class="tag tag-{{this}} small">{{this}}</span>
                    {{/each}}
                  </div>
                  <div class="flavor-files">
                    {{#each files}}
                      <div class="file-item {{#if animated}}animated{{/if}}">
                        <span class="file-name">
                          {{#if animated}}<i class="fas fa-film"></i>{{/if}}
                          {{#if sub_variant}}
                            {{sub_variant}}
                          {{else}}
                            Standard
                          {{/if}}
                        </span>
                        <div class="file-actions">
                          <button class="btn-icon btn-preview"
                                  data-action="preview"
                                  data-location-id="{{../../id}}"
                                  data-flavor-index="{{@../index}}"
                                  data-file-index="{{@index}}"
                                  title="{{localize 'MAP_BROWSER.Preview'}}">
                            <i class="fas fa-eye"></i>
                          </button>
                          <button class="btn-primary btn-create"
                                  data-action="create-scene"
                                  data-location-id="{{../../id}}"
                                  data-flavor-index="{{@../index}}"
                                  data-file-index="{{@index}}"
                                  title="{{localize 'MAP_BROWSER.CreateScene'}}">
                            <i class="fas fa-plus"></i>
                            Scene
                          </button>
                        </div>
                      </div>
                    {{/each}}
                  </div>
                </div>
              {{/each}}
            </div>
          {{/if}}
        </div>
      {{/each}}
    </div>

    {{#unless locations.length}}
      <div class="empty-state">
        <i class="fas fa-search"></i>
        <p>{{localize "MAP_BROWSER.NoResults"}}</p>
      </div>
    {{/unless}}
  {{/if}}
</div>

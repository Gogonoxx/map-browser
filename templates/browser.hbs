<div class="map-browser-container">
  {{#if loading}}
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <span>{{localize "MAP_BROWSER.Loading"}}</span>
    </div>
  {{else}}
    <!-- Header -->
    <div class="browser-header">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" name="search" placeholder="{{localize 'MAP_BROWSER.Search'}}"
               value="{{searchQuery}}" autofocus>
      </div>
      <button class="animated-toggle {{#if showAnimatedOnly}}active{{/if}}" data-action="toggle-animated" title="{{#if showAnimatedOnly}}Alle Maps anzeigen{{else}}Nur animierte Maps{{/if}}">
        <i class="fas fa-film"></i>
        {{#if showAnimatedOnly}}
          Animiert ({{animatedCount}})
        {{else}}
          Alle
        {{/if}}
      </button>
      <div class="stats">
        <span class="stat">
          <i class="fas fa-map-marker-alt"></i>
          {{totalLocations}} {{localize "MAP_BROWSER.Locations"}}
        </span>
        <span class="stat">
          <i class="fas fa-layer-group"></i>
          {{totalFlavors}} {{localize "MAP_BROWSER.Flavors"}}
        </span>
        <span class="stat">
          <i class="fas fa-file-image"></i>
          {{totalFiles}} {{localize "MAP_BROWSER.Files"}}
        </span>
      </div>
    </div>

    {{#unless hasOneDriveUrl}}
      <div class="warning-banner">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{localize "MAP_BROWSER.ConfigureOneDrive"}}</span>
      </div>
    {{/unless}}

    {{#if searchQuery}}
      <div class="search-results-info">
        <span>{{resultCount}} Ergebnisse für "{{searchQuery}}"</span>
        {{#unless resultCount}}
          <button class="clear-search" onclick="this.closest('.map-browser-container').querySelector('[name=search]').value=''; this.closest('.map-browser-container').querySelector('[name=search]').dispatchEvent(new Event('input'))">
            <i class="fas fa-times"></i> Suche löschen
          </button>
        {{/unless}}
      </div>
    {{/if}}

    <!-- Location Grid -->
    <div class="locations-grid">
      {{#each locations}}
        <div class="location-card {{#if expanded}}expanded{{/if}}" data-location-id="{{id}}">
          <!-- Card Header -->
          <div class="card-header" data-action="toggle-location" data-location-id="{{id}}">
            <img class="location-thumbnail" src="{{thumbnail}}" alt="{{title}}"
                 loading="lazy" onerror="this.src='icons/svg/mystery-man.svg'">
            <div class="card-info">
              <h3 class="location-title">{{title}}</h3>
              <div class="location-meta">
                <span class="flavor-count">{{flavor_count}} Varianten</span>
                {{#if has_animated}}
                  <span class="animated-badge" title="{{localize 'MAP_BROWSER.Animated'}}">
                    <i class="fas fa-film"></i>
                  </span>
                {{/if}}
              </div>
              <div class="smart-tags">
                {{#each tagBadges}}
                  <span class="tag tag-{{this}}">{{this}}</span>
                {{/each}}
              </div>
            </div>
            <i class="fas fa-chevron-{{#if expanded}}up{{else}}down{{/if}} expand-icon"></i>
          </div>

          <!-- Expanded Flavor Panel -->
          {{#if expanded}}
            <div class="flavors-panel">
              {{#each flavors}}
                <div class="flavor-group">
                  <div class="flavor-header">
                    <span class="flavor-name">{{display_name}}</span>
                    {{#if has_animated}}
                      <span class="animated-badge small">
                        <i class="fas fa-film"></i>
                      </span>
                    {{/if}}
                    {{#each smart_tags}}
                      <span class="tag tag-{{this}} small">{{this}}</span>
                    {{/each}}
                  </div>
                  <div class="flavor-files">
                    {{!-- Beneos Maps: Show Scenery + Battlemap with thumbnails --}}
                    {{#if scenery_files}}
                      <div class="beneos-actions">
                        {{#if scenery_files.length}}
                          <div class="beneos-option">
                            {{#if scenery_files.0.variantThumb}}
                              <img class="variant-thumbnail" src="{{scenery_files.0.variantThumb}}" alt="Scenery"
                                   loading="lazy" onerror="this.style.display='none'">
                            {{/if}}
                            <button class="btn-beneos btn-scenery"
                                    data-action="create-beneos-scene"
                                    data-location-id="{{../id}}"
                                    data-flavor-index="{{@index}}"
                                    data-file-type="scenery"
                                    title="Cinematic Scenery erstellen">
                              <i class="fas fa-film"></i>
                              Scenery
                              {{#if scenery_files.0.animated}}<span class="badge-animated">▶</span>{{/if}}
                            </button>
                          </div>
                        {{/if}}
                        {{#if battlemap_files.length}}
                          <div class="beneos-option">
                            {{#if battlemap_files.0.variantThumb}}
                              <img class="variant-thumbnail" src="{{battlemap_files.0.variantThumb}}" alt="Battlemap"
                                   loading="lazy" onerror="this.style.display='none'">
                            {{/if}}
                            <button class="btn-beneos btn-battlemap"
                                    data-action="create-beneos-scene"
                                    data-location-id="{{../id}}"
                                    data-flavor-index="{{@index}}"
                                    data-file-type="battlemap"
                                    title="Battlemap erstellen">
                              <i class="fas fa-chess-board"></i>
                              Battlemap
                              {{#if battlemap_files.0.animated}}<span class="badge-animated">▶</span>{{/if}}
                            </button>
                          </div>
                        {{/if}}
                        {{#if audio_file}}
                          <span class="audio-indicator" title="Audio verfügbar: {{audio_file}}">
                            <i class="fas fa-volume-up"></i>
                          </span>
                        {{/if}}
                      </div>
                    {{else}}
                      {{!-- Czepeku Maps: Original file list --}}
                      {{#each files}}
                        <div class="file-item {{#if animated}}animated{{/if}}">
                          {{#if variantThumb}}
                            <img class="variant-thumbnail" src="{{variantThumb}}" alt=""
                                 loading="lazy" onerror="this.style.display='none'">
                          {{/if}}
                          <span class="file-name">
                            {{#if animated}}<i class="fas fa-film"></i>{{/if}}
                            {{#if sub_variant}}
                              {{sub_variant}}
                            {{else}}
                              Standard
                            {{/if}}
                          </span>
                          <div class="file-actions">
                            <button class="btn-primary btn-create"
                                    data-action="create-scene"
                                    data-location-id="{{../../id}}"
                                    data-flavor-index="{{@../index}}"
                                    data-file-index="{{@index}}"
                                    title="{{localize 'MAP_BROWSER.CreateScene'}}">
                              <i class="fas fa-plus"></i>
                              Scene
                            </button>
                          </div>
                        </div>
                      {{/each}}
                    {{/if}}
                  </div>
                </div>
              {{/each}}
            </div>
          {{/if}}
        </div>
      {{/each}}
    </div>

    {{#unless locations.length}}
      <div class="empty-state">
        <i class="fas fa-search"></i>
        <p>{{localize "MAP_BROWSER.NoResults"}}</p>
      </div>
    {{/unless}}
  {{/if}}
</div>
